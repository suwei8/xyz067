name: Spaceship Domain Scanner

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci || npm install
      
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Run domain scan with hourly commits
      run: |
        # è·å–è¿è¡Œè®¡æ•°
        RUN_COUNT_FILE=".github/run_count"
        if [ -f "$RUN_COUNT_FILE" ]; then
          RUN_COUNT=$(cat $RUN_COUNT_FILE)
        else
          RUN_COUNT=0
        fi
        
        RUN_COUNT=$((RUN_COUNT + 1))
        echo $RUN_COUNT > $RUN_COUNT_FILE
        
        echo "å½“å‰è¿è¡Œæ¬¡æ•°: $RUN_COUNT/6"
        echo "å¼€å§‹æ‰«ææ—¶é—´: $(date)"
        
        # è¿è¡Œæ‰«æ
        npm run scan:puppeteer
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœæ–‡ä»¶å¹¶æäº¤
        if [ -f "found_0_67.md" ]; then
          echo "å‘ç°æ‰«æç»“æœï¼Œå‡†å¤‡æäº¤..."
          
          # æ·»åŠ æ—¶é—´æˆ³åˆ°æ–‡ä»¶æœ«å°¾
          echo "" >> found_0_67.md
          echo "<!-- æ‰«ææ—¶é—´: $(date) è¿è¡Œæ¬¡æ•°: $RUN_COUNT -->" >> found_0_67.md
          
          # æäº¤ç»“æœ
          git add found_0_67.md $RUN_COUNT_FILE
          git commit -m "åŸŸåæ‰«æç»“æœæ›´æ–° - $(date '+%Y-%m-%d %H:%M') (ç¬¬${RUN_COUNT}æ¬¡)" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push
          
          echo "âœ… ç»“æœå·²æäº¤å¹¶æ¨é€"
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ‰«æç»“æœæ–‡ä»¶"
          # ä»ç„¶æäº¤è¿è¡Œè®¡æ•°
          git add $RUN_COUNT_FILE
          git commit -m "æ›´æ–°è¿è¡Œè®¡æ•°: $RUN_COUNT (æ— æ‰«æç»“æœ)" || echo "è®¡æ•°å™¨æ— éœ€æäº¤"
          git push
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ6æ¬¡ï¼ˆ5.5å°æ—¶ï¼‰
        if [ $RUN_COUNT -ge 6 ]; then
          echo "ğŸ›‘ å·²è¾¾åˆ°æœ€å¤§è¿è¡Œæ¬¡æ•°(6æ¬¡)ï¼Œé‡ç½®è®¡æ•°å™¨å¹¶åœæ­¢"
          # é‡ç½®è®¡æ•°å™¨
          echo "0" > $RUN_COUNT_FILE
          git add $RUN_COUNT_FILE
          git commit -m "é‡ç½®è¿è¡Œè®¡æ•°å™¨ - å®Œæˆä¸€è½®æ‰«æ" || echo "é‡ç½®æ— éœ€æäº¤"
          git push
          
          # åˆ›å»ºåœæ­¢æ ‡è®°ï¼ˆå¯é€‰ï¼‰
          echo "COMPLETED_AT=$(date)" > .github/last_completion
          git add .github/last_completion
          git commit -m "æ ‡è®°æ‰«æè½®æ¬¡å®Œæˆ - $(date)" || echo "å®Œæˆæ ‡è®°æ— éœ€æäº¤"
          git push
          
          echo "âœ… æœ¬è½®æ‰«æå®Œæˆï¼Œå·¥ä½œæµå°†åœæ­¢"
        else
          echo "â³ ç»§ç»­ç­‰å¾…ä¸‹æ¬¡æ‰«æï¼Œå‰©ä½™ $((6 - RUN_COUNT)) æ¬¡"
        fi
        
    - name: Upload artifacts (å¤‡ä»½)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scan-results-${{ github.run_number }}
        path: |
          found_0_67.md
          errors.log
          .github/run_count
          .github/last_completion
        retention-days: 7